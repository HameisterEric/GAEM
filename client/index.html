<title> GAEM </title>
<div id ="signDiv">
	Username: <input id = "signDiv-username" type = "text"></input><br>
	Password: <input id = "signDiv-password" type = "password"></input><br>
	Map(randomly assigned if empty): <input id = "signDiv-map" type = "text" onkeypress='return event.charCode >= 48 && event.charCode <= 57'></input>
	<form id = "playerType">
		<input type="radio" name="playerTypes" value="Knight"> Knight<br>
		<input type="radio" name="playerTypes" value="Wizard"> Wizard<br>
		<input type="radio" name="playerTypes" value="Thief"> Thief<br>
		<input type="radio" name="playerTypes" value="Shaman"> Shaman<br>
	</form>
	<button id = "signDiv-signIn">Sign In</button>
	<button id = "signDiv-signUp">Sign Up</button>
</div>

<div id ="gameDiv" style = "display:none;">

	<canvas id = "ctx" width = "500" height="500"> </canvas>
	<div id = "chat-text" style = "width 500px;height:100px;overflow-y:scroll"></div>

	<form id = "chat-form">
		<input id = "chat-input" type = "text" style ="width:500px"> </input>
	</form>
	
</div>
<script src = "https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
	var socket = io();
	var signDiv = document.getElementById('signDiv');
	var signDivUsername = document.getElementById('signDiv-username');
	var signDivSignIn = document.getElementById('signDiv-signIn');
	var signDivSignUp = document.getElementById('signDiv-signUp');
	var signDivPassword = document.getElementById('signDiv-password');
	var signDivMap = document.getElementById('signDiv-map');
	var playerType = document.getElementById('playerType');
	var images = [
	"img/CharacterKnight.png",
	"img/CharacterWizard.png",
	"img/CharacterThief.png",
	"img/CharacterShaman.png",
	"img/mob1.png"
	];
	Sprite.list = {};
	var loader = function(i){
		var image = new Image();
		image.src = images[i];
		console.log(image.src);
		image.addEventListener('load',function(){
			Sprite.list[image.src.substring(image.src.indexOf("img")+4,image.src.length-4)] = new Sprite(image, 32, 32, 10);
			if(i < images.length - 1) loader(i+1);
		});
	}
	loader(0);
	signDivSignIn.onclick = function(){
		if(playerType.elements["playerTypes"].value)
		socket.emit('signIn',{username: signDivUsername.value, password: signDivPassword.value});
	}
	signDivSignUp.onclick = function(){
		socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
	}
	socket.on('signInResponse',function(data){
		if(data.success){
			signDiv.style.display = 'none';
			gameDiv.style.display = 'inline-block';
			var hero = new Image();
			hero.src = "img/CharacterKnight.png";
			hero.addEventListener('load', function(){
				socket.emit('loaded',{playerType: playerType.elements["playerTypes"].value, map: signDivMap.value});
			});
		}
		else
			alert("Sign in failed");
	});
	socket.on('signUpResponse',function(data){
		if(data.success){
			alert("Sign up successful");
		}
		else
			alert("Sign up failed");
	});
	
	var ctx = document.getElementById("ctx").getContext("2d");
	ctx.imageSmoothingEnabled = false;
	var chatText = document.getElementById('chat-text');
	var chatInput = document.getElementById('chat-input');
	var chatForm = document.getElementById('chat-form');
	ctx.font = "30px Ariel";
	var positions;
	socket.on('newPosition',function(data){
		positions = data;
	});
	
	socket.on('addToChat', function(data){
		chatText.innerHTML += '<div>' + data + '</div>';
	});
		
	chatForm.onsubmit = function(e){
		e.preventDefault();
		socket.emit('sendText',chatInput.value);
		chatInput.value = '';
	}
	
	var Player = function(pack){
		var self = {};
		self.number = pack.number;
		self.x = pack.x;
		self.y = pack.y;
		self.sprite = Sprite.list["Character"+ pack.being];
		self.sprite = new Sprite(self.sprite.image,self.sprite.width,self.sprite.height,self.sprite.rowLength);
		Player.list[self.number] = self;
		return self;
	}
	Player.list = {};
	var Mob = function(pack){
		var self = {}
		self.number = pack.number;
		self.x = pack.x;
		self.y = pack.y;
		self.sprite = Sprite.list[pack.being];
		self.sprite = new Sprite(self.sprite.image,self.sprite.width,self.sprite.height,self.sprite.rowLength);
		Mob.list[self.number] = self;
		return self;
	}
	Mob.list = {};
	socket.on('init', function(data){
		for(var i in data.players){
			new Player(data.players[i]);
		}
		for(var i in data.mobs){
			new Mob(data.mobs[i]);
		}
	});
	socket.on('update',function(data){
		for(var i in data.players){
			Player.list[data.players[i].number].x = data.players[i].x;
			Player.list[data.players[i].number].y = data.players[i].y;
 		}
		for(var i in data.mobs){
			Mob.list[data.mobs[i].number].x = data.mobs[i].x;
			Mob.list[data.mobs[i].number].y = data.mobs[i].y;
 		}
	});
	socket.on('remove',function(data){
		for(var i in data.players){
			delete Player.list[data.players[i].number];
 		}
		for(var i in data.mobs){
			delete Mob.list[data.mobs[i].number];
 		}
	});
	socket.on('changeRow',function(data){
		for(var i in data.players){
			Player.list[data.players[i].number].sprite.index = 0;
			Player.list[data.players[i].number].sprite.framesOn = 0;
			Player.list[data.players[i].number].sprite.row = data.players[i].row;
			if(data.players[i].reverse) Player.list[data.players[i].number].sprite.reverse = data.players[i].reverse;
		}
		for(var i in data.mobs){
			Mob.list[data.mobs[i].number].sprite.index = 0;
			Mob.list[data.mobs[i].number].sprite.framesOn = 0;
			Mob.list[data.mobs[i].number].sprite.row = data.mobs[i].row;
			if(data.mobs[i].reverse) Mob.list[data.mobs[i].number].sprite.reverse = data.mobs[i].reverse;
		}
	});
function Sprite(image, width, height, rowLength){
	this.image = image;
	this.width = width;
	this.height = height;
	this.index = 0;
	this.row = 0;
	this.rowLength = rowLength;
	this.framesOn = 0;
	this.reverse = 1;
	this.draw = function(xPosition, yPosition){
		ctx.save();
		if(this.reverse === -1) ctx.scale(-1,1);
		ctx.drawImage(this.image,this.width*this.index,this.height*this.row,this.width,this.height,this.reverse*(xPosition-this.width*3/2),yPosition+this.height,this.reverse*this.width*3,this.height*3);
		ctx.restore();
		if (this.framesOn >= 60/rowLength){
			this.index++;
			this.framesOn = 0;
		}
		this.framesOn++;
		if(this.index>this.rowLength-1) this.index = 0;
	}
}
	setInterval(function(){
		ctx.clearRect(0,0,500,500);
		for(var i in Player.list){
			Player.list[i].sprite.draw(Player.list[i].x,Player.list[i].y);
		}
		for(var i in Mob.list){
			Mob.list[i].sprite.draw(Mob.list[i].x,Mob.list[i].y);
		}
	},1000/60);
	</script>